name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: europe-west1
  GAR_LOCATION: europe-west1

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      service-name: ${{ steps.set-env.outputs.service-name }}

    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "service-name=book-review-prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "service-name=book-review-staging" >> $GITHUB_OUTPUT
          else
            echo "::error::Unsupported branch: ${{ github.ref }}"
            exit 1
          fi

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, bcmath, pdo_mysql
          coverage: none

      - name: Copy .env
        run: cp .env.example .env

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Generate application key
        run: php artisan key:generate

      - name: Run tests
        run: php artisan test

      - name: Run Pint
        run: ./vendor/bin/pint --test

  build-and-deploy:
    needs: [setup, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required config
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          CLOUDSQL_CONNECTION_NAME: ${{ secrets.CLOUDSQL_CONNECTION_NAME }}
        run: |
          if [[ -z "$GCP_SA_KEY" ]]; then
            echo "::error::GCP_SA_KEY secret is not set. Please configure it in GitHub repository settings."
            exit 1
          fi

          if [[ -z "$PROJECT_ID" ]]; then
            echo "::error::GCP_PROJECT_ID variable is not set. Please configure it in GitHub repository settings."
            exit 1
          fi

          if [[ -z "$CLOUDSQL_CONNECTION_NAME" ]]; then
            echo "::error::CLOUDSQL_CONNECTION_NAME secret is not set. Add it like: project:region:instance"
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build \
            --build-arg APP_ENV=${{ needs.setup.outputs.environment }} \
            -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/book-review/${{ needs.setup.outputs.service-name }}:${{ github.sha }} \
            -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/book-review/${{ needs.setup.outputs.service-name }}:latest \
            -f Dockerfile.cloudrun .

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/book-review/${{ needs.setup.outputs.service-name }}:${{ github.sha }}
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/book-review/${{ needs.setup.outputs.service-name }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ needs.setup.outputs.service-name }} \
            --image ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/book-review/${{ needs.setup.outputs.service-name }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --add-cloudsql-instances ${{ secrets.CLOUDSQL_CONNECTION_NAME }} \
            --allow-unauthenticated \
            --set-env-vars "APP_ENV=${{ needs.setup.outputs.environment }}" \
            --set-env-vars "APP_DEBUG=${{ vars.APP_DEBUG }}" \
            --set-env-vars "APP_KEY=${{ secrets.APP_KEY }}" \
            --set-env-vars "DB_CONNECTION=mysql" \
            --set-env-vars "DB_HOST=/cloudsql/${{ secrets.CLOUDSQL_CONNECTION_NAME }}" \
            --set-env-vars "DB_PORT=3306" \
            --set-env-vars "DB_DATABASE=${{ secrets.DB_DATABASE }}" \
            --set-env-vars "DB_USERNAME=${{ secrets.DB_USERNAME }}" \
            --set-env-vars "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --min-instances 0 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --concurrency 80

      - name: Run database migrations (Cloud Run Job)
        run: |
          gcloud run jobs create ${{ needs.setup.outputs.service-name }}-migrate-${{ github.sha }} \
            --image ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/book-review/${{ needs.setup.outputs.service-name }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --set-env-vars "APP_ENV=${{ needs.setup.outputs.environment }}" \
            --set-env-vars "APP_KEY=${{ secrets.APP_KEY }}" \
            --set-env-vars "DB_CONNECTION=mysql" \
            --set-env-vars "DB_HOST=/cloudsql/${{ secrets.CLOUDSQL_CONNECTION_NAME }}" \
            --set-env-vars "DB_PORT=3306" \
            --set-env-vars "DB_DATABASE=${{ secrets.DB_DATABASE }}" \
            --set-env-vars "DB_USERNAME=${{ secrets.DB_USERNAME }}" \
            --set-env-vars "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --command "php" \
            --args "artisan,migrate,--force" \
            --task-timeout 300 || true

          gcloud run jobs execute ${{ needs.setup.outputs.service-name }}-migrate-${{ github.sha }} \
            --region ${{ env.REGION }} \
            --wait || true

      - name: Output deployment URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ needs.setup.outputs.service-name }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "ðŸš€ Deployed to: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

      - name: Post deployment notification
        if: success()
        run: |
          echo "âœ… Successfully deployed ${{ needs.setup.outputs.service-name }} to ${{ needs.setup.outputs.environment }}"
